#!/usr/bin/env bash

# Main logic callback for daily sleeps to check cert status
function main {
  # Check if env vars are set
  if [ -z ${EMAIL+x} ]; then echo "Fatal: administrator email address must be specified with the environment variable named 'EMAIL'"; exit 1; fi
  if [ -z ${SERVERIP+x} ]; then echo "Fatal: domain must be specified with the environment variable named 'SERVERIP'"; exit 1; fi
  # Attempt a cert issue
  /usr/local/bin/certbot-auto certonly \
  --verbose \
  --noninteractive \
  --manual \
  --server "https://acme-v02.api.letsencrypt.org/directory" \
  --preferred-challenges dns \
  --agree-tos \
  --manual-public-ip-logging-ok \
  --email="${EMAIL}" \
  -d "*.${SERVERIP}" \
  --manual-auth-hook /usr/local/bin/txthook
  # Restart the gateway once a day for now
  /usr/bin/supervisorctl restart taisun-gateway
  sleep 86400
  main
}


# Run main logic
main
